<?xml version="1.0" encoding="UTF-8" ?>
<!-- mapper DTD 선언 -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- mapper 자체가 DAO 분리되어 나온 개념이기 때문에 namespace는 DAO 명을 따라가는 경우가 일반적임 -->
<mapper namespace="InstagramDAO">
	<!-- 인스타 스토리 가져오기 -->
 	<select id="getStoryList" parameterType="userinfo" resultType="userinfo">
		SELECT idx
 			 , user_name
 			 , regdate
 			 , img_path
 			 , IFNULL (( select 1 from instagram.story_log sl where view_user_idx = 99 and story_idx = A.idx ), 0) as view_yn 
		  FROM instagram.user_info A		  	 
 	</select>
 	<select id="getStory" parameterType="story" resultType="story">
 		SELECT idx
	 		 , content
	 		 , regdate
	 		 , img_path
	 		 , user_idx
	      FROM instagram.story	 
	     WHERE user_idx = #{user_idx}
 	</select>
 	<insert id="setViewStory" parameterType="story">
 		INSERT INTO instagram.story_log
			( 
				story_user_idx
				, view_user_idx
				, regdate
				, story_idx
			)
		VALUES(	
				#{user_idx}
				, 99	<!-- 로그인기능 구현 후 수정 필요 -->
				, now()
				, (				
				  select MIN(idx) from instagram.story s 
				   where user_idx = #{user_idx}
				     and idx not in (select story_idx from instagram.story_log sl where view_user_idx = 99 and user_idx = #{user_idx}) 
				   group by user_idx 
				)				
			)
		 		
 	</insert>
 	
 	<!-- 새 피드 저장하기 -->
 	<insert id="setSaveNewFeed" parameterType="feedlist">
	 	INSERT INTO instagram.feed_list
			(
				user_idx
				, feed_contents
				, regdate
				, use_yn
			)
		VALUES
			(
				#{user_idx}
				, #{feed_contents}
				, NOW()
				, 'Y'
			) 	
 	</insert>
 	
 	<select id="getNewFeedIdx" parameterType="feedlist" resultType="int">
		SELECT MAX(feed_idx) FROM instagram.feed_list
		 WHERE user_idx = #{user_idx} 	 
 	</select>
 	
 	<!-- 새  피드 이미지 파일 저장하기 -->
 	<insert id="setSaveNewFeedFile" parameterType="feedphoto">
	 	INSERT INTO instagram.feed_photo
			(
				feed_idx
				, file_name
				, file_path
			)
		VALUES
			(
				#{feed_idx}
				, #{file_name}
				, NULL
			);
 	</insert>
 	
 	<!-- 새 스토리 저장하기 -->
 	<insert id="setSaveNewStory" parameterType="storylist">
	 	INSERT INTO instagram.story_list
			(
				user_idx
				, regdate
				, use_yn
			)
		VALUES
			(
				#{user_idx}
				, NOW()
				, #{use_yn}
			)
 	</insert>
 	
 	<select id="getNewStoryIdx" parameterType="storylist" resultType="int">
		SELECT MAX(story_idx) FROM instagram.story_list
		 WHERE user_idx = #{user_idx}  	 
 	</select>
 	
 	<!-- 새 스토리 이미지 파일 저장하기 -->
 	<insert id="setSaveNewStoryFile" parameterType="storyphoto">
	 	INSERT INTO instagram.story_photo
			(
				story_idx
				, file_name
				, file_path
			)
		VALUES
			(
				#{story_idx}
				, #{file_name}
				, NULL
			)
 	</insert>
 	
 	<!-- 홈 피드 리스트 가져오기 -->
 	<select id="getFeedTemp" parameterType="feedlist" resultType="feedlist">
   	   SELECT FL.FEED_IDX 
			, FL.FEED_CONTENTS 
			, FL.REGDATE 
			, FL.FILE_NAMES
			, FL.USER_NICKNAME
			, MAX(FL2.LIKE_TYPE) AS LIKE_TYPE
			, COUNT(FL2.LIKE_TYPE) AS LIKE_COUNT
		FROM (
		   SELECT FL.FEED_IDX 
				, FL.FEED_CONTENTS 
				, FL.REGDATE 
				, JSON_ARRAYAGG(FP.FILE_NAME) AS FILE_NAMES
				, UI.USER_NICKNAME
			 FROM FEED_LIST FL
			INNER JOIN FEED_PHOTO FP
			ON FL.FEED_IDX = FP.FEED_IDX 
			INNER JOIN USER_INFO UI 
			ON FL.USER_IDX = UI.USER_IDX
			GROUP BY FL.FEED_IDX 
		) FL
		LEFT JOIN FEED_LIKE FL2 
		ON FL.FEED_IDX = FL2.FEED_IDX 
		GROUP BY FL.FEED_IDX 
		ORDER BY FL.REGDATE desc			
 	</select>
 	
 	<!-- 선택한 홈 피드 팝업 -->
 	<select id="getFeedPopup" parameterType="feedlist" resultType="feedlist">
   	   SELECT FL.FEED_IDX 
			, FL.FEED_CONTENTS 
			, FL.REGDATE 
			, FL.FILE_NAMES
			, FL.USER_NICKNAME
			, MAX(FL2.LIKE_TYPE) AS LIKE_TYPE
			, COUNT(FL2.LIKE_TYPE) AS LIKE_COUNT
			, FL.FEED_REPLY_LIST
		FROM (
		   SELECT FL.FEED_IDX 
				, FL.FEED_CONTENTS 
				, FL.REGDATE 
				, JSON_ARRAYAGG(FP.FILE_NAME) AS FILE_NAMES
				, JSON_ARRAYAGG(
					JSON_OBJECT(
				        'feed_reply_idx', FR.FEED_REPLY_IDX ,
				        'user_idx', FR.USER_IDX ,
				        'feed_reply_contents', FR.FEED_REPLY_CONTENTS,
				        'user_nickname', UI2.USER_NICKNAME
			      	)
				) AS FEED_REPLY_LIST
				, UI.USER_NICKNAME
			 FROM FEED_LIST FL
			INNER JOIN FEED_PHOTO FP
			ON FL.FEED_IDX = FP.FEED_IDX 
			INNER JOIN USER_INFO UI 
			ON FL.USER_IDX = UI.USER_IDX
			LEFT JOIN FEED_REPLY FR 
			ON FL.FEED_IDX = FR.FEED_IDX	
			LEFT JOIN USER_INFO UI2
			ON UI2.USER_IDX = FR.USER_IDX 			
			WHERE FL.FEED_IDX = #{feed_idx}
			GROUP BY FL.FEED_IDX 
		) FL
		LEFT JOIN FEED_LIKE FL2 
		ON FL.FEED_IDX = FL2.FEED_IDX 
		GROUP BY FL.FEED_IDX 
		ORDER BY FL.REGDATE DESC
 	</select>
 	
 	<!-- 피드 좋아요 저장 -->
 	<insert id="setInsertFeedLike" parameterType="feedlike">
	 	INSERT INTO instagram.feed_like
			(
				feed_idx
				, user_idx
				, like_type
			)
		VALUES
			(
				#{feed_idx}
				, #{user_idx}
				, 1
			)
 	</insert>
 	
 	<!-- 피드 좋아요 삭제 -->
 	<delete id="setDeleteFeedLike" parameterType="feedlike">
	 	DELETE FROM instagram.feed_like
		WHERE feed_idx = #{feed_idx}
		  AND user_idx = #{user_idx}
 	</delete>
 	
 	<!-- 피드 댓글 저장 -->
 	<insert id="setFeedReply" parameterType="feedreply">
	 	INSERT INTO instagram.feed_reply
			(
				feed_idx
				, user_idx
				, feed_reply_contents
				, pidx
			)
		VALUES
			(
				#{feed_idx}
				, #{user_idx}
				, #{feed_reply_contents}
				, 0
			);
	</insert>
 	
</mapper>
